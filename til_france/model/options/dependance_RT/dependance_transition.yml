import:
  - dependance_functions.yml
  - dependance_transition_functions.yml

globals:
  # periodic do not work
  dependance_prevalence_all_years:
    type: float


entities:
  individus:
    fields:
      #  Etat 0 : autonomie et aucune atteinte ´
      #  Etat 1 : limitations fonctionnelles ´
      #  Etat 2 : restrictions dans les IADL (Echelle de Lawton) ´
      #  Etat 3 : restrictions dans les ADL (Echelle de Katz) ´
      #  Etat 4 : restrictions dans les ADL les plus sévères ´
      #  Etat 5 : décès
      - dependance_anciennete: {type: int, initialdata: false, default: -1}
      - dependance_niveau: {type: int, initialdata: true}

    processes:
      dependance_initialisation:
        - qm: if(
            ISMALE,
            individu2generation.qm_male,
            individu2generation.qm_female
            )
        - qm_2010: if(
            ISMALE,
            individu2generation.qm_male_2010,
            individu2generation.qm_female_2010
            )
        - lq: log((MU * qm + (1 - MU) * qm_2010)) / (1 - (MU * qm + (1 - MU) * qm_2010))
        # primaire, college; lycee, premier cycle du superieur, second cyle du superieur, troisieme cycle du superieur
        - etudes: (education_niveau > individu2generation.education_niveau)
        - nb_enfants: if(
            ISMALE,
            invl_pere.count(),
            invl_mere.count()
            )
        - dependance_niveau: 0
        # TODO age min ?
        - dependance_niveau: if(
            ISMALE and (age < 75),
            compute_dependance_niveau_homme_inf_75(lq, nb_enfants),
            dependance_niveau
            )
        - dependance_niveau: if(
            ISMALE and (age >= 75),
            compute_dependance_niveau_homme_sup_75(lq, nb_enfants),
            dependance_niveau
            )
        # TODO age min ?
        - dependance_niveau: if(
            ISFEMALE and (age < 80),
            compute_dependance_niveau_femme_inf_80(lq, nb_enfants),
            dependance_niveau
            )
        - dependance_niveau: if(
            ISFEMALE and (age >= 80),
            compute_dependance_niveau_femme_sup_80(lq, nb_enfants),
            dependance_niveau
            )
        - age_category: if(
            age >= 60,
            min(trunc(age / 5) - 12 + 1, 6),
            0
            )
        - dependance_anciennete: if(dependance_niveau >= 1, 1, -1)
        - show('\nNombre initial de dépendants avant alignement', groupby(dependance_niveau, data_origin))
        # TODO parameters/dependance/dependance_prevalence_2010.csv depends on weight

      dependance:
        # Transitions depuis les états initiaux suivants
        - dependance_niveau_from_0: etat_0()
        - dependance_niveau_from_1: etat_1()
        - dependance_niveau_from_2: etat_2()
        - dependance_niveau_from_3: etat_3()
        - dependance_niveau_from_4: etat_4()
        - dependance_niveau: if(
            dependance_niveau == 0,
            dependance_niveau_from_0,
            if(
              dependance_niveau == 1,
              dependance_niveau_from_1,
              if(
                dependance_niveau == 2,
                dependance_niveau_from_2,
                if(
                  dependance_niveau == 3,
                  dependance_niveau_from_3,
                  dependance_niveau_from_4
                  )
                )
              )
            )
        - dependance_anciennete: if(dependance_niveau >= 1, dependance_anciennete + 1, -1)
