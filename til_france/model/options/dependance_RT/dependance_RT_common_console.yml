# Using cohort matrix

import:
   - ../../standard/console.yml
   - ../generations/generation.yml
   - dependance_initialisation_functions.yml
   - deces_dependance.yml
   - dependance_transition.yml

globals:
  transition:
    path: test.csv
    type: float

entities:
  individus:

    macros:
      MU: 1

    processes:
      options_initialisation:
        - dependance_initialisation()

      options_statistiques_initialisation:
        - dependance_statistiques_initialisation()

      dependance_statistiques_initialisation:
        - csv('dependance_by_period', fname = 'dependance.csv')
        - csv('dependance_niveau_by_period', fname = 'dependance_niveau.csv')
        - csv('incidence_by_period', fname = 'dependance_incidence.csv')
        - csv('dependance_deces_by_period', fname = 'dependance_deces.csv')

      options_statistiques_fin_de_periode:
        - dependance_statistiques_fin_de_periode()

      dependance_statistiques_fin_de_periode:
        - csv('period', period, 'dependance', groupby(
            age, sexe, expr = count(dependance_niveau >= 1)
            ),
            fname = 'dependance.csv',
            mode = 'a'
            )
        - csv(
            groupby(period, age, sexe, dependance_niveau, count()),
            fname = 'dependance_niveau.csv',
            mode = 'a'
            )
        - csv(
            groupby(
              period,
              age,
              sexe,
              (dependance_niveau >= 1) and (dependance_anciennete == 0),
              filter = (age >= 60)
              ),
            fname = 'dependance_incidence.csv',
            mode = 'a'
            )

  generation:
    fields:
      - dependance_transition_homme_0_0: {type: float, initialdata: False}

    processes:
      dependance_transition_initialisation:
        - show('initialisation transition')
        - show(transition)
        - dependance_transition_homme_0_0: transition[0, 0:121, 0, 0]
        - show(dependance_transition_homme_0_0[72])

      mise_a_jour:
        - education()
        - mortality_rates_update()
        - dependance_transition_initialisation()

      options_initialisation:
        - mortality_rates_initialisation()
        - dependance_transition_initialisation()

